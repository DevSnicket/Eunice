<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <link href="../favicon.ico" rel="icon" type="image/x-icon" />
    <link href="../index.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet">
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .arrows-with-descriptions {
            background-image: url(../arrows/with-descriptions.svg);
            background-position: center;
            background-repeat: no-repeat;
            background-size: contain;
            height: 10em;
        }

        code > .new {
            font-weight: bold;
        }

        .content > img,
        .image-right > img {
            display: block;
            margin: 0 auto;
        }

        @media (min-width: 52em) {
            .image-right {
                align-items: flex-start;
                display: flex;
                flex-wrap: wrap;
            }

            .image-right > :first-child {
                flex-basis: 0;
                flex-grow: 1;
                margin-right: 0.5em;
            }

            .image-right > img {
                margin-left: 0.5em;
            }
        }
        

        @media (prefers-color-scheme: dark) {
            .arrows-with-descriptions {
                background-image: url(../arrows/dark/with-descriptions.svg);
            }
        }
    </style>
    <title>Case Studies | Eunice</title>
</head>
<body>
    <div class="header">
        <div class="content">
            <h1><a href=".."><span><span class="red">e</span>uni<span class="red">ce</span></span><div class="arrows"></div></a></h1>
            <span class="menu"><a href="..">introduction</a><a href="../structure">structure</a><a href="../dependencies">dependencies</a><a class="current" href="../case-studies">case studies</a><a href="../javascript">JavaScript<a href="../issues">issues</a><a href="../licensing">licensing</a><a href="../advanced">advanced</a></span>
        </div>
    </div>
    <div class="content">
        <h2 style="margin-bottom: 0">React case study</h2>
        <div class="image-right">
            <div>
                <p>This case study investigates and demonstrates the capabilities of Eunice, by using Eunice on the JavaScript library <a href="https://reactjs.org/" target="_blank">React</a>.</p>
                <p>The case study isn't intended as a commentary or critique of React. Decisions made during it are constrained by the authors understanding of React. With more insight into React, different choices might be made if Eunice was used by its contributors.</p>
                <p style="margin-bottom: 0">Suggestions to improve the case study are welcome. Hopefully it's helpful to React contributors or to those who have an interest in React.</p>
            </div>
            <img alt="React logo" src="../react.svg" style="width:8em" />
        </div>
        <p>I've based the case study on the <a href="https://github.com/DevSnicket/react/commit/0f3838a01b0fda0ac5fd054c6be13166697a113c" target="_blank">0f3838a</a> commit in the React repository. I've created a fork to make it easier if you want to follow along:</p>
        <code>git clone https://github.com/DevSnicket/react.git react-eunice
cd react-eunice</code>
        <p>Eunice can be downloaded from NPM and run without installing using NPX:</p>
        <code>npx eunice</code>
        <p>You will be prompted to accept a EULA. Eunice is free to use on open source projects, and its free to use for education and training. Therefore contributions to React and following along with this case study both qualify. There is also an evaluation period to try Eunice out on closed source commercial software.</p>
        <div class="horizontal-menu">
            <a href="#syntax">syntax</a>
            <a href="#file-order">file order</a>
            <a href="#codebase-conventions">codebase conventions</a>
            <a href="#directory-specific">directory specific</a>
            <a href="#groups">groups</a>
            <a href="#tests">tests</a>
            <a href="#conclusion">conclusion</a>
            <a href="#featured-on">featured on</a>
        </div>
        <h3 id="syntax">syntax</h3>
        <p>Running Eunice on React without any parameters will raise the following error:</p>
        <code>Error: Analysis of file "packages\create-subscription\index.js" raised the following error.

Unexpected token, expected ";" (14:5)</code>
        <p>This error is raised because React uses <a href="https://flow.org/" target="_blank">Flow</a> syntax in its JavaScript. Eunice uses <a hre="https://babeljs.io/" target="_blank"> Babel</a> to parse JavaScript and a Flow plug-in can be enabled with the option <a href="../javascript/options/#babel-parser-plugins">babel-parser-plugins</a>. Some of the Babel parser plug-ins are enabled by default and so will also need to be specified so they aren't disabled when enabling Flow:</p>
        <code>npx eunice \
<span class="new">--babel-parser-plugins=classPrivateProperties \
--babel-parser-plugins=classProperties \
--babel-parser-plugins=dynamicImport \
--babel-parser-plugins=flow \
--babel-parser-plugins=jsx</span></code>
        <p>Running Eunice with the Babel plug-ins specified above will raise a further error:</p>
        <code>Error: Analysis of file "scripts\prettier\index.js" raised the following error.

'return' outside of function (32:2)</code>
        <p>Eunice parses with a <a href="https://babeljs.io/docs/en/options#sourcetype" target="_blank">Babel source type</a> of module, but the file specified in the error is a script. The option <a href="../javascript/options/#ignore-paths">ignore-path-pattern</a> can be used to ignore the "script" directory. I've also included the default ignores and one for babel.config.js. The option is specified with double quotes as the pipe character is used in the regular expression.</p>
        <code>npx eunice \
<span class="new">--ignore-path-pattern="(^(\.|babel.config.js|scripts)|node_modules)" \</span>
--babel-parser-plugins=classPrivateProperties \
--babel-parser-plugins=classProperties \
--babel-parser-plugins=dynamicImport \
--babel-parser-plugins=flow \
--babel-parser-plugins=jsx</code>
        <p>Analysis with the options above should complete successfully and output a eunice.html file. Opening the file in a browser should show the following:</p>
        <img src="./1-initial-root.png" />
        <p>On the left a text editor is displaying 78,696 lines of <a href="../advanced/yaml">YAML</a> produced by Eunice's analysis and <a href="../javascript/processing">processing</a> of React.</p>
        <p>On the right is a graphical representation of all the <a href="../dependencies">dependencies</a> and the root directories (fixtures and packages) in React. The green and red count arrows represent the dependencies, categorized as follows:</p>
        <p>So far, no additional <a href="../structure">structure</a> has been defined in any stacks, so we see items listed horizontally.</p>
        <div class="arrows-with-descriptions"></div>
        <p>Ideally all dependencies should be matching, shown as counts only in the green down arrows and no red arrows. This would be a demonstration (as far as Eunice JavaScript analysis is currently capable) that dependencies were all unidirectional, including indirect dependencies.</p>
        <img src="../structure/stacks.svg" style="background: white; padding: 0.5em;" />
        <p>An example of software that’s close to having only unidirectional dependencies is Eunice itself, you can see this by looking at its <a href="https://en.wikipedia.org/wiki/Eating_your_own_dog_food" target="_blank">dogfooding</a>:</p>
        <img src="../dogfooding/index.svg" style="background: white; padding: 0.5em;" />
        <p>You can interact with Eunice's dogfooding <a href="../dogfooding" target="_blank">here</a>.</p>
        <h3 id="file-order">file order</h3>
        <p>Eunice can infer stacks, in JavaScript this includes the order within a file. In the browser, if for example, dangerfile is selected, the contents of the file dangerfile.js are displayed:</p>
        <img src="./4-file-sorting-default-dangerfile.png" />
        <p>The items in the lowest level are all the module import and CommonJS require calls that Eunice automatically moves below the file content. The other two levels have dependencies that don’t match and so have counts shown in red up arrows. By default Eunice expects code within a file to be ordered high level first with more detail as you move down. The option <a href="../javascript/options/#reverse-file">is-file-content-reversed</a> can reverse this:</p>
        <code>npx eunice \
<span class="new">--is-file-content-reversed=true \</span>
--ignore-path-pattern="(^(\.|babel.config.js|scripts)|node_modules)" \
--babel-parser-plugins=classPrivateProperties \
--babel-parser-plugins=classProperties \
--babel-parser-plugins=dynamicImport \
--babel-parser-plugins=flow \
--babel-parser-plugins=jsx</code>
        <p>The file will then show with all matching green dependency counts (after reloading the browser):</p>
        <img src="./5-file-sorting-reversed-dangerfile.png" />
        <p>Looking at the root directory, a lot more of Reacts dependencies are now shown as matching in green:</p>
        <img src="./6-file-sorting-reversed-root.png" />
        <p>There are still 1,592 dependencies, shown in a red horizontal arrow, that are between items that don’t have a structure defined yet.</p>
        <h3 id="codebase-conventions">codebase conventions</h3>
        <p>There are often conventions in codebases and in React there are many instances of directories that are always either above or below all the other directories. One example is that the __tests__ directory depends on what it tests. Another example is that the rest of the code depends on the shared directory. This is represented below in YAML, with "existing" being used as placeholder for items not specified:</p>
        <code>- [ forks, __tests__ ]
- - existing
- - src
- - shared</code>
        <p>The YAML above can be saved into a file (.eunice-stack-modify.yaml) and that file can be specified with the <a href="../javascript/options/#modify-stacks">modify-stacks-file</a> option so that Eunice modifies all stacks with the following option:</p>

        <code>npx eunice \
<span class="new">--modify-stacks-file=.eunice-stack-modify.yaml \</span>
--is-file-content-reversed=true \
--ignore-path-pattern="(^(\.|babel.config.js|scripts)|node_modules)" \
--babel-parser-plugins=classPrivateProperties \
--babel-parser-plugins=classProperties \
--babel-parser-plugins=dynamicImport \
--babel-parser-plugins=flow \
--babel-parser-plugins=jsx</code>
        <p>You can see examples of what effect this has in React by looking inside packages/react-interactions/events and its sub-directory src/dom:</p>
        <img src="./7-modify-file-stacks-interactions.png" />
        <br />
        <img src="./8-modify-file-stacks-interactions-events.png" />
        <p>This reduces the count of mismatching dependencies in the red horizontal arrow by over a third, from 1,592 to 903:</p>
        <img src="./9-modify-file-stacks-root.png" />
        <h3 id="directory-specific">directory specific</h3>
        <p>YAML stack files of structure like the one above can also be created for individual directories. Eunice automatically does this when files named .eunice-stack.yaml are saved with the code. I've worked through React and created 36 stack files. If you want to view the files I've created a branch called with-stacks was created and the stack files added in commit <a href="https://github.com/DevSnicket/react/commit/4dffcae81fdcfa8d288bd350d74517bd6d7d4a26" target="_blank">4dffcae</a>.</p>
        <p>The stacks have removed all the remaining 903 unstructured dependencies; however, I wasn't able to define structures that would make all dependencies go in the same direction. These mismatching dependencies are shown in the red up arrow count of 815 below:</p>
        <img src="./10-individual-file-stacks-root.png"/>
        <p>You can see more specific dependency count arrows and the structure I chose, by looking inside the packages sub-directory:</p>
        <img src="./11-individual-file-stack-packages.png" />
        <h3 id="groups">groups</h3>
        <p>The packages directory has enough items and levels that it can be hard to remember what all the dependency relationships are. This can be improved by grouping items that share concepts and dependency relationships.</p>
        <p>The six sub-directories highlighted below all relate to devtools, have dependency counts that don't require their distribution across the stack and so could be grouped:</p>
        <img src="./12-devtools-highlighted.png" />
        <p>To investigate how this might look the Eunice stack file in the packages directory can be modified. I've added a new item named react-devtools-group and moved the six related items inside it:</p>
        <code>- - existing
<span class="new">- - id: react-devtools-group
    dependencyPermeable: true
    items:
      - [ react-devtools, react-devtools-shell ]
      - [ react-devtools-core, react-devtools-inline ]
      - - react-devtools-extensions
      - - react-devtools-shared</span>
- [ react-art, react-interactions, react-refresh ]
- - react-test-renderer
- [ react-dom, react-native-renderer, react-noop-renderer ]
- [ legacy-events, react-reconciler ]
- [ create-subscription, jest-mock-scheduler, jest-react, react-cache, react-is, react-stream, use-subscription ]
- [ babel-plugin-react-jsx, eslint-plugin-react-hooks, react, react-debug-tools, scheduler, shared ]</code>
        <p>The new item has been marked in the YAML as dependencyPermeable so that Eunice's dependency resolution will look inside it even though it won't be specified in the code's import statement paths.</p>
        <p>Re-running the analysis and reloading the web page shows that this makes the packages directory clearer without adding any mismatching dependencies:</p>
        <img src="13-devtools-group.png" />
        <p>Selecting the new react-devtools-group shows its stack:</p>
        <img src="14-devtools-group-contents.png" />
        <p>To make this grouping more permanent and implicit the Eunice stack above could be replaced with a new sub-directory in the code.</p>
        <p>The example above was an obvious group to create, with the shared concept (devtools) already defined, high cohesion within its items and a simple relationship with the rest of the system. To get the same effect elsewhere, more detailed work might be required, directly in the code, moving small pieces around from across many parts of a system.</p>
        <h3 id="tests">tests</h3>
        <p>While looking through the React code base I noticed some of the package scoped bi-directional dependencies were only in its tests. This can be investigated by modifying the ignore path pattern to exclude test related directories:</p>
        <code>npx eunice \
--ignore-path-pattern="(^(\.|babel.config.js|scripts<span class="new">|fixtures</span>)|node_modules<span class="new">|__tests__</span>)" \
--modify-stacks-file=.eunice-stack-modify.yaml \
--is-file-content-reversed=true \
--babel-parser-plugins=classPrivateProperties \
--babel-parser-plugins=classProperties \
--babel-parser-plugins=dynamicImport \
--babel-parser-plugins=flow \
--babel-parser-plugins=jsx</code>
        <p>Re-running the analysis and reloading the web page shows that with tests ignored, the number of sub-directories with no bi-directional dependencies at the package scope has improved. Note that Eunice has detected that react-test-renderer no longer needs to be stacked in a separate level and so has automatically moved it up into the level above:</p>
        <img src="./15-ignore-tests.png" />
        <p>The remaining red mismatching dependency arrows across packages are from react-flight and react-server onto react-dom. Modifying the packages directory stack can, for the first time, get all the package scoped dependencies uni-directional. This can be done by moving react-flight and react-server below react-dom:</p>
        <code>- - existing
- - id: react-devtools-group
    dependencyPermeable: true
    items:
      - [ react-devtools, react-devtools-shell ]
      - [ react-devtools-core, react-devtools-inline ]
      - - react-devtools-extensions
      - - react-devtools-shared
- [ react-art, react-interactions, react-refresh ]
- - react-test-renderer
- [ react-dom, react-native-renderer, react-noop-renderer ]
- [ legacy-events, <span class="new">react-flight,</span> react-reconciler, <span class="new">react-server</span> ]
- [ create-subscription, jest-mock-scheduler, jest-react, react-cache, react-is, react-stream, use-subscription ]
- [ babel-plugin-react-jsx, eslint-plugin-react-hooks, react, react-debug-tools, scheduler, shared ]</code>
        <br/>
        <p>We can now see in Eunice that the only dependencies across the packages sub-directories are those from tests, as there are no package scoped mismatching red arrows:</p>
        <img src="./16-ignore-tests-specific-stack.png" />
        <h3 id="conclusion">conclusion</h3>
        <p>You can interact the case study <a href="eunice.html" target="_blank">here</a>.</p>
        <p>The structures I've chosen for React are what I think are best fit for the current dependencies. This structure might not be ideal for React and its future development. It might be beneficial to structure differently, which would have higher counts of current mismatching dependencies, but would encourage contributors to change the code and its dependencies to better match that intended structure.</p>
        <p>I defined these structures for React as an individual; however, by committing stack files to source control and running Eunice (e.g. in continuous integration), teams could collaborate and collectively define and improve the structure.</p>
        <h3 id="featured-on">featured on</h3>
        dev.to
        <ul>
            <li><a href="https://dev.to/grahamdyson/analyzing-the-architecture-of-react-its-structure-and-dependencies-with-eunice-1h8c">Analyzing the architecture of React, its structure and dependencies, with Eunice</a></li>
            <li><a href="https://dev.to/grahamdyson/grouping-code-with-eunice-2c63">Grouping code with Eunice</a></li>
            <li><a href="https://dev.to/grahamdyson/test-scope-and-isolation-with-eunice-47hn">Test scope and isolation with Eunice</a>
        </ul>
        hackernoon.com
        <ul><li><a href="https://hackernoon.com/eunice-analysis-of-react-2k1y32tl" target="_blank">A Deep Dive Into The Architecture of React: Structure and Dependencies (feat. Eunice)</a></li></ul>
        medium.com
        <ul>
            <li><a href="https://medium.com/@grahamdyson/eunice-on-react-a44a3b55342d">Analyzing the architecture of React, its structure and dependencies, with Eunice</a></li>
            <li><a href="https://medium.com/@grahamdyson/grouping-code-with-eunice-3d5298d5994d">Grouping code with Eunice</a></li>
            <li><a href="https://medium.com/@grahamdyson/test-scope-and-isolation-with-eunice-cbbc40a20770">Test scope and isolation with Eunice</a>
        </ul>
    </div>
    <div class="footer">
        <p class="links">
            <a class="email" href="mailto:eunice@devsnicket.com">eunice@devsnicket.com</a>
            <a class="twitter" href="https://twitter.com/devsnicket" target="_blank">twitter.com/devsnicket</a>
            <a class="github" href="https://github.com/DevSnicket" target="_blank">github.com/DevSnicket</a>
        </p>
        <p>Copyright © 2019 Graham Dyson</p>
    </div>
</body>
</html>